<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>surgeRy: basic example explained • surgeRy</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="surgeRy: basic example explained">
<meta property="og:description" content="surgeRy">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">surgeRy</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/surgeRy.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/surgeRygen.html">surgeRy: basic landmark data generation example explained</a>
    </li>
    <li>
      <a href="../articles/surgeRygencropseg.html">surgeRy: point-based cropping and segmentation data generation example</a>
    </li>
    <li>
      <a href="../articles/surgeRytrain.html">surgeRy: basic landmark unet training example explained</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/stnava/surgeRy/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>surgeRy: basic example explained</h1>
            
            <h4 class="date">2021-11-22</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/stnava/surgeRy/blob/master/vignettes/surgeRy.Rmd"><code>vignettes/surgeRy.Rmd</code></a></small>
      <div class="hidden name"><code>surgeRy.Rmd</code></div>

    </div>

    
    
<div id="overview-of-surgery" class="section level1">
<h1 class="hasAnchor">
<a href="#overview-of-surgery" class="anchor"></a>Overview of <code>surgeRy</code>
</h1>
<p>surgeRy is a package that helps the user organize and implement efficient, augmented training with ANTsRNet. the primary target audience is those who are working with volumetric data but 2D will work too. the basic idea is to make training more efficient through numpy-based I/O of the “infinite” training data that we can often generate.</p>
<p>the augmentation strategy will use:</p>
<ul>
<li><p>geometric transformation of images (rigid, affine, etc)</p></li>
<li><p>gaussian noise</p></li>
<li><p>simulated bias field</p></li>
<li><p>histogram warping</p></li>
</ul>
<p>to create new versions of images from an input image list. Segmentations will be augmented as well and there are options for treating the segmentations as points. One can convert points (in physical space) to segmentation images via <code>ANTsR</code> function <code>makePointsImage</code> or by converting physical points to an index via <code>antsTransformPhysicalPointToIndex</code>. If one uses the latter approach, one should encode each point by a unique label.</p>
<div id="setting-up-the-data" class="section level2">
<h2 class="hasAnchor">
<a href="#setting-up-the-data" class="anchor"></a>Setting up the data</h2>
<p><strong>Run on both threads when setting up</strong></p>
<p>Environment variables control multi-threading for CPU in ANTs and tensorflow. See below for how to set these at the beginning on an experiment. We set the number of threads to 12 below.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html">Sys.setenv</a></span><span class="op">(</span><span class="st">"TF_NUM_INTEROP_THREADS"</span><span class="op">=</span><span class="fl">12</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html">Sys.setenv</a></span><span class="op">(</span><span class="st">"TF_NUM_INTRAOP_THREADS"</span><span class="op">=</span><span class="fl">12</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html">Sys.setenv</a></span><span class="op">(</span><span class="st">"ITK_GLOBAL_DEFAULT_NUMBER_OF_THREADS"</span><span class="op">=</span><span class="fl">12</span><span class="op">)</span></code></pre></div>
<p>See the code below for how to assemble the images for augmentation.</p>
<p><strong>Run on both threads when setting up</strong></p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># record the GPU</span>
<span class="va">gpuid</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"CUDA_VISIBLE_DEVICES"</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span> <span class="va">ANTsR</span> <span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span> <span class="va"><a href="https://github.com/ANTsX/ANTsRNet">ANTsRNet</a></span> <span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span> <span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span> <span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span> <span class="va"><a href="https://keras.rstudio.com">keras</a></span> <span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span> <span class="va"><a href="https://github.com/rstudio/tfdatasets">tfdatasets</a></span> <span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span> <span class="va"><a href="https://github.com/rstudio/reticulate">reticulate</a></span> <span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span> <span class="va">patchMatchR</span> <span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span> <span class="va"><a href="https://github.com/stnava/surgeRy">surgeRy</a></span> <span class="op">)</span>
<span class="va">np</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/reticulate/man/import.html">import</a></span><span class="op">(</span><span class="st">"numpy"</span><span class="op">)</span>
<span class="va">mytype</span> <span class="op">=</span> <span class="st">"float32"</span>
<span class="va">nlayers</span> <span class="op">=</span> <span class="fl">4</span>   <span class="co"># for unet</span>
<span class="va">downsam</span> <span class="op">=</span> <span class="fl">4</span>   <span class="co"># downsamples images</span>
<span class="co"># collect your images - a list of lists - multiple entries in each list are fine</span>
<span class="va">rids</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span> <span class="va">x</span>, <span class="va">downsammer</span><span class="op">=</span><span class="fl">4</span> <span class="op">)</span> <span class="op">{</span>
  <span class="va">img</span> <span class="op">=</span> <span class="fu">ri</span><span class="op">(</span> <span class="va">x</span> <span class="op">)</span>
  <span class="fu">resampleImage</span><span class="op">(</span> <span class="va">img</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">img</span><span class="op">)</span><span class="op">/</span><span class="va">downsammer</span>, useVoxels<span class="op">=</span><span class="cn">TRUE</span> <span class="op">)</span>
<span class="op">}</span>
<span class="va">upperhalf</span> <span class="op">=</span> <span class="fu">rids</span><span class="op">(</span> <span class="fl">1</span> <span class="op">)</span> <span class="op">*</span> <span class="fl">0</span> <span class="op">+</span> <span class="fl">1</span> <span class="co"># this just gives us more segmentation labels</span>
<span class="va">upperhalf</span><span class="op">[</span><span class="fl">33</span><span class="op">:</span><span class="fl">64</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">32</span><span class="op">]</span> <span class="op">=</span> <span class="fl">2</span>
<span class="va">upperhalf</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">32</span>,<span class="fl">33</span><span class="op">:</span><span class="fl">64</span><span class="op">]</span> <span class="op">=</span> <span class="fl">3</span>
<span class="va">upperhalf</span><span class="op">[</span><span class="fl">33</span><span class="op">:</span><span class="fl">64</span>,<span class="fl">33</span><span class="op">:</span><span class="fl">64</span><span class="op">]</span> <span class="op">=</span> <span class="fl">4</span>
<span class="va">ilist</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span> <span class="fu">rids</span><span class="op">(</span> <span class="fl">1</span> <span class="op">)</span>, <span class="fu">getMask</span><span class="op">(</span> <span class="fu">rids</span><span class="op">(</span> <span class="fl">1</span> <span class="op">)</span> <span class="op">)</span> <span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span> <span class="fu">rids</span><span class="op">(</span> <span class="fl">2</span> <span class="op">)</span>, <span class="fu">getMask</span><span class="op">(</span> <span class="fu">rids</span><span class="op">(</span> <span class="fl">2</span> <span class="op">)</span> <span class="op">)</span> <span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span> <span class="fu">rids</span><span class="op">(</span> <span class="fl">3</span> <span class="op">)</span>, <span class="fu">getMask</span><span class="op">(</span> <span class="fu">rids</span><span class="op">(</span> <span class="fl">3</span> <span class="op">)</span> <span class="op">)</span> <span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span> <span class="fu">rids</span><span class="op">(</span> <span class="fl">4</span> <span class="op">)</span>, <span class="fu">getMask</span><span class="op">(</span> <span class="fu">rids</span><span class="op">(</span> <span class="fl">4</span> <span class="op">)</span> <span class="op">)</span> <span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span> <span class="fu">rids</span><span class="op">(</span> <span class="fl">6</span> <span class="op">)</span>, <span class="fu">getMask</span><span class="op">(</span> <span class="fu">rids</span><span class="op">(</span> <span class="fl">6</span> <span class="op">)</span> <span class="op">)</span> <span class="op">)</span> <span class="op">)</span>

<span class="va">slist</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span> <span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span> <span class="va">ilist</span> <span class="op">)</span> <span class="op">)</span> <span class="op">{</span>
  <span class="va">temp</span> <span class="op">=</span> <span class="fu">thresholdImage</span><span class="op">(</span> <span class="va">ilist</span><span class="op">[[</span><span class="va">k</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="st">"Otsu"</span>, <span class="fl">3</span> <span class="op">)</span>
  <span class="va">temp</span> <span class="op">=</span> <span class="va">temp</span> <span class="op">*</span> <span class="op">(</span> <span class="va">ilist</span><span class="op">[[</span><span class="va">k</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op">-</span> <span class="fu">iMath</span><span class="op">(</span> <span class="va">ilist</span><span class="op">[[</span><span class="va">k</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, <span class="st">"ME"</span>, <span class="fl">6</span> <span class="op">)</span> <span class="op">)</span>
  <span class="va">slist</span><span class="op">[[</span><span class="va">k</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu">thresholdImage</span><span class="op">(</span> <span class="va">temp</span>, <span class="fl">2</span>, <span class="fl">2</span> <span class="op">)</span> <span class="op">*</span> <span class="va">upperhalf</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="va">ilist</span><span class="op">[[</span><span class="va">k</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">slist</span><span class="op">[[</span><span class="va">k</span><span class="op">]</span><span class="op">]</span> <span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Here are definitions for some variables important for training: the numbers defining the segmentation labels and which images are for training and testing.</p>
<p><strong>Run on both threads when setting up</strong></p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># identify the number of segmentation classes</span>
<span class="va">segregions</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span> <span class="va">slist</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>  <span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span> <span class="co"># the seg numbers</span>
<span class="va">isTrain</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="cn">TRUE</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">slist</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span>, <span class="cn">FALSE</span> <span class="op">)</span></code></pre></div>
<p>This example will do landmark learning. If doing segmentation, then include the zero label i.e. just <code><a href="https://rdrr.io/r/base/sort.html">sort( unique( slist[[1]]  ))</a></code>.</p>
</div>
<div id="preparing-to-write-the-data-to-disk" class="section level2">
<h2 class="hasAnchor">
<a href="#preparing-to-write-the-data-to-disk" class="anchor"></a>Preparing to write the data to disk</h2>
<p>We will generate (in this case) 5 files. For each, we generate a random file unique ID and then create file extensions that map to the type of augmented data we will be generating. In this case, we will generate augmented images, the associated masks, the points, coord conv output and a heatmap. These all derive from the image lists we defined above. This stuff will be run on CPU separately from the training loop.</p>
<p><strong>Run on CPU thread when setting up</strong></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nFiles</span> <span class="op">=</span> <span class="fl">5</span>
<span class="kw">if</span> <span class="op">(</span> <span class="op">!</span> <span class="fu"><a href="https://rdrr.io/r/base/exists.html">exists</a></span><span class="op">(</span> <span class="st">"uid"</span> <span class="op">)</span> <span class="op">)</span>
  <span class="va">uid</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"LM"</span>,<span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">1000000</span>,<span class="va">nFiles</span><span class="op">)</span>,<span class="st">"Z"</span><span class="op">)</span>
<span class="va">types</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Images.npy"</span>, <span class="st">"Points.npy"</span>, <span class="st">"mask.npy"</span>, <span class="st">"coordconv.npy"</span>, <span class="st">"heatmap.npy"</span> <span class="op">)</span>
<span class="va">nmats</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">types</span><span class="op">)</span> <span class="co"># 5 arrays out</span>
<span class="va">trainTestFileNames</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="st">""</span>,nrow<span class="op">=</span><span class="va">nFiles</span>,ncol<span class="op">=</span><span class="va">nmats</span><span class="op">*</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="va">colnamesTT</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"train"</span>,<span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">".npy"</span>,<span class="st">""</span>,<span class="va">types</span><span class="op">)</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"test"</span>,<span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">".npy"</span>,<span class="st">""</span>,<span class="va">types</span><span class="op">)</span><span class="op">)</span> <span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span> <span class="va">trainTestFileNames</span> <span class="op">)</span> <span class="op">=</span> <span class="va">colnamesTT</span>
<span class="kw">for</span> <span class="op">(</span> <span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nFiles</span> <span class="op">)</span> <span class="op">{</span>
  <span class="va">twogroups</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"numpy/"</span>,<span class="va">uid</span><span class="op">[</span><span class="va">k</span><span class="op">]</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"train"</span>,<span class="st">"test"</span><span class="op">)</span><span class="op">)</span>
  <span class="va">npextsTr</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span> <span class="va">twogroups</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">types</span> <span class="op">)</span>
  <span class="va">npextsTe</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span> <span class="va">twogroups</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">types</span> <span class="op">)</span>
  <span class="va">trainTestFileNames</span><span class="op">[</span><span class="va">k</span>,<span class="op">]</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">npextsTr</span>,<span class="va">npextsTe</span><span class="op">)</span> <span class="op">)</span>
<span class="op">}</span>
<span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span> <span class="va">trainTestFileNames</span>, <span class="st">"numpy/LMtrainttestfiles.csv"</span>, row.names<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
</div>
<div id="augmenting-the-data" class="section level2">
<h2 class="hasAnchor">
<a href="#augmenting-the-data" class="anchor"></a>Augmenting the data</h2>
<p>We generate the data based on default parameters. If you want to learn more about the possibilities here, then please change the parameters and take a look at the results. We will show an example that looks at some parameter variations below.</p>
<p>The call below will write a test file to numpy. We just write one in this case as we keep it constant during training. Write as many as you want for your application</p>
<p><strong>Run on CPU thread when setting up</strong></p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">testfilename</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">trainTestFileNames</span><span class="op">[</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="st">"test"</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">trainTestFileNames</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
<span class="va">gg</span> <span class="op">=</span> <span class="fu"><a href="../reference/generateDiskData.html">generateDiskData</a></span><span class="op">(</span>
    inputImageList <span class="op">=</span> <span class="va">ilist</span>,
    segmentationImageList <span class="op">=</span> <span class="va">slist</span>,
    segmentationNumbers <span class="op">=</span> <span class="va">segregions</span>,
    selector <span class="op">=</span> <span class="op">!</span><span class="va">isTrain</span>,
    addCoordConv <span class="op">=</span> <span class="cn">TRUE</span>,
    segmentationsArePoints <span class="op">=</span> <span class="cn">TRUE</span>,
    smoothHeatMaps <span class="op">=</span> <span class="fl">3.0</span>,
    maskIndex <span class="op">=</span> <span class="fl">2</span>,
    transformType <span class="op">=</span> <span class="st">"scaleShear"</span>,
    noiseParameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.05</span><span class="op">)</span>,
    sdSimulatedBiasField <span class="op">=</span> <span class="fl">0.01</span>,
    sdHistogramWarping <span class="op">=</span> <span class="fl">0.01</span>,
    sdAffine <span class="op">=</span> <span class="fl">0.1</span>, <span class="co"># limited</span>
    numpynames <span class="op">=</span> <span class="va">testfilename</span>,
    numberOfSimulations <span class="op">=</span> <span class="fl">8</span>
    <span class="op">)</span>
<span class="co"># visualize example augmented images</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/layout.html">layout</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">8</span>,nrow<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span> <span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">8</span> <span class="op">)</span> <span class="op">{</span>
  <span class="va">temp</span> <span class="op">=</span> <span class="fu">as.antsImage</span><span class="op">(</span> <span class="va">gg</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="va">k</span>,,,<span class="fl">1</span><span class="op">]</span> <span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="va">temp</span> <span class="op">)</span>
  <span class="op">}</span></code></pre></div>
<p>We would typically run something like the code below in a continuous loop on a CPU thread separate from the GPU training loop. In practice, you may keep the parameters the same across train and test or set minimal augmentation parameters for test data.</p>
<p><strong>Run on CPU thread when setting up</strong></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">while</span><span class="op">(</span> <span class="cn">TRUE</span> <span class="op">)</span> <span class="op">{</span>
  <span class="kw">for</span> <span class="op">(</span> <span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nFiles</span> <span class="op">)</span> <span class="op">{</span>
    <span class="va">trnfilename</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">trainTestFileNames</span><span class="op">[</span><span class="va">k</span>,<span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="st">"train"</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">trainTestFileNames</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">k</span>, <span class="va">trnfilename</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">)</span> <span class="op">)</span>
    <span class="va">gg</span> <span class="op">=</span> <span class="fu"><a href="../reference/generateDiskData.html">generateDiskData</a></span><span class="op">(</span>
        inputImageList <span class="op">=</span> <span class="va">ilist</span>,
        segmentationImageList <span class="op">=</span> <span class="va">slist</span>,
        segmentationNumbers <span class="op">=</span> <span class="va">segregions</span>,
        selector <span class="op">=</span> <span class="va">isTrain</span>,
        addCoordConv <span class="op">=</span> <span class="cn">TRUE</span>,
        segmentationsArePoints <span class="op">=</span> <span class="cn">TRUE</span>,
        smoothHeatMaps <span class="op">=</span> <span class="fl">3.0</span>,
        maskIndex <span class="op">=</span> <span class="fl">2</span>,
        transformType <span class="op">=</span> <span class="st">"scaleShear"</span>,
        noiseParameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.05</span><span class="op">)</span>,
        sdSimulatedBiasField <span class="op">=</span> <span class="fl">0.01</span>,
        sdHistogramWarping <span class="op">=</span> <span class="fl">0.01</span>,
        sdAffine <span class="op">=</span> <span class="fl">0.1</span>,
        numpynames <span class="op">=</span> <span class="va">trnfilename</span>,
        numberOfSimulations <span class="op">=</span> <span class="fl">64</span>
        <span class="op">)</span>
    <span class="op">}</span>
  <span class="op">}</span></code></pre></div>
<p>Getting the above steps correct is very critical to successful training. This package currently hides some of that complexity for basic segmentation and landmark prediction. However, it is always possible to make mistakes if the training decisions are inconsistent with the underlying theory. A forthcoming publication will explain the theory associated with this package.</p>
</div>
<div id="set-up-the-unet" class="section level2">
<h2 class="hasAnchor">
<a href="#set-up-the-unet" class="anchor"></a>set up the unet</h2>
<p>Below is the default set up for unet-based lanmdark prediction given the above augmentation choices.</p>
<p><strong>Run on GPU thread when setting up</strong></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span> <span class="va">ANTsR</span> <span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span> <span class="va"><a href="https://github.com/ANTsX/ANTsRNet">ANTsRNet</a></span> <span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span> <span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span> <span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span> <span class="va"><a href="https://keras.rstudio.com">keras</a></span> <span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span> <span class="va"><a href="https://github.com/rstudio/tfdatasets">tfdatasets</a></span> <span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span> <span class="va"><a href="https://github.com/rstudio/reticulate">reticulate</a></span> <span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span> <span class="va">patchMatchR</span> <span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span> <span class="va"><a href="https://github.com/stnava/surgeRy">surgeRy</a></span> <span class="op">)</span>
<span class="va">np</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/reticulate/man/import.html">import</a></span><span class="op">(</span><span class="st">"numpy"</span><span class="op">)</span>
<span class="va">mytype</span> <span class="op">=</span> <span class="st">"float32"</span>
<span class="va">nlayers</span> <span class="op">=</span> <span class="fl">4</span>   <span class="co"># for unet</span>
<span class="va">downsam</span> <span class="op">=</span> <span class="fl">4</span>   <span class="co"># downsamples images</span>
<span class="co"># set up the network - all parameters below could be optimized for the application</span>
<span class="va">unet</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ANTsRNet/man/createUnetModel2D.html">createUnetModel2D</a></span><span class="op">(</span>
       <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span> <span class="cn">NULL</span>, <span class="cn">NULL</span>, <span class="fl">1</span> <span class="op">)</span>,
       numberOfOutputs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span> <span class="va">segregions</span> <span class="op">)</span>,
       numberOfLayers <span class="op">=</span> <span class="va">nlayers</span>, <span class="co"># should optimize this wrt criterion</span>
       numberOfFiltersAtBaseLayer <span class="op">=</span> <span class="fl">32</span>, <span class="co"># should optimize this wrt criterion</span>
       convolutionKernelSize <span class="op">=</span> <span class="fl">3</span>, <span class="co"># maybe should optimize this wrt criterion</span>
       deconvolutionKernelSize <span class="op">=</span> <span class="fl">2</span>,
       poolSize <span class="op">=</span> <span class="fl">2</span>,
       strides <span class="op">=</span> <span class="fl">2</span>,
       dropoutRate <span class="op">=</span> <span class="fl">0</span>,
       weightDecay <span class="op">=</span> <span class="fl">0</span>,
       additionalOptions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span> <span class="st">"nnUnetActivationStyle"</span> <span class="op">)</span>,
       mode <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"regression"</span><span class="op">)</span>
     <span class="op">)</span>
<span class="va">maskinput</span> <span class="op">=</span> <span class="fu"><a href="https://keras.rstudio.com/reference/layer_input.html">layer_input</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span> <span class="cn">NULL</span>, <span class="cn">NULL</span>, <span class="fl">1</span> <span class="op">)</span> <span class="op">)</span>
<span class="va">posteriorMask</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://keras.rstudio.com/reference/layer_multiply.html">layer_multiply</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span> <span class="va">unet</span><span class="op">$</span><span class="va">outputs</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> , <span class="va">maskinput</span> <span class="op">)</span>, name<span class="op">=</span><span class="st">'maskTimesPosteriors'</span>  <span class="op">)</span>
<span class="va">unet</span> <span class="op">=</span> <span class="fu"><a href="https://keras.rstudio.com/reference/keras_model.html">keras_model</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span> <span class="va">unet</span><span class="op">$</span><span class="va">inputs</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">maskinput</span> <span class="op">)</span>, <span class="va">posteriorMask</span> <span class="op">)</span>
<span class="va">unetLM</span> <span class="op">=</span> <span class="fu">patchMatchR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/patchMatchR/man/deepLandmarkRegressionWithHeatmaps.html">deepLandmarkRegressionWithHeatmaps</a></span><span class="op">(</span> <span class="va">unet</span>,
  activation <span class="op">=</span> <span class="st">'none'</span>, theta<span class="op">=</span><span class="fl">0</span> <span class="op">)</span>
<span class="va">unetLM1</span> <span class="op">=</span> <span class="fu">patchMatchR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/patchMatchR/man/deepLandmarkRegressionWithHeatmaps.html">deepLandmarkRegressionWithHeatmaps</a></span><span class="op">(</span> <span class="va">unet</span>,
  activation <span class="op">=</span> <span class="st">'relu'</span>, theta<span class="op">=</span><span class="fl">0</span> <span class="op">)</span></code></pre></div>
</div>
<div id="reading-the-data-from-disk" class="section level2">
<h2 class="hasAnchor">
<a href="#reading-the-data-from-disk" class="anchor"></a>Reading the data from disk</h2>
<p>Now we have to read the data from disk in a parallel thread. We handle this by looking at the file modification times and we, by default, choose to read the file that was modified <em>2nd</em> most recently.</p>
<p>The functions below handle how to choose which image to read for training. Some experimentation may be needed to get the timing correct. You want to balance the time it takes to augment versus the time it takes to train through a batch.</p>
<p><strong>Run on GPU thread when setting up</strong></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">trtefns</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span> <span class="st">"numpy/LMtrainttestfiles.csv"</span> <span class="op">)</span> <span class="co"># critical - same file name</span>
<span class="va">trnnames</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">trtefns</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="st">"train"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">trtefns</span><span class="op">)</span> <span class="op">)</span><span class="op">]</span>
<span class="va">tstnames</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">trtefns</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="st">"test"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">trtefns</span><span class="op">)</span> <span class="op">)</span><span class="op">]</span>
<span class="va">loadfirst</span> <span class="op">=</span> <span class="fu"><a href="../reference/chooseTrainingFilesToRead.html">chooseTrainingFilesToRead</a></span><span class="op">(</span> <span class="va">trtefns</span><span class="op">[</span>,<span class="va">trnnames</span><span class="op">]</span> <span class="op">)</span>
<span class="va">Xtr</span> <span class="op">=</span> <span class="fu">surgeRy</span><span class="fu">::</span><span class="fu"><a href="../reference/loadNPData.html">loadNPData</a></span><span class="op">(</span> <span class="va">loadfirst</span> <span class="op">)</span>
<span class="va">mybs</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span> <span class="va">Xtr</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
<span class="va">Xte</span> <span class="op">=</span> <span class="fu">surgeRy</span><span class="fu">::</span><span class="fu"><a href="../reference/loadNPData.html">loadNPData</a></span><span class="op">(</span> <span class="va">trtefns</span><span class="op">[</span><span class="fl">1</span>,<span class="va">tstnames</span><span class="op">]</span> <span class="op">)</span></code></pre></div>
<p>spatial tensors are indexed in the following way:</p>
<ul>
<li>first index: subject (or batch) index</li>
<li>second index: x coordinate</li>
<li>third index : y coordinate</li>
<li>fourth index : z or channels</li>
<li>last/fifth index (if available): channels</li>
</ul>
<p>e.g in this example we see:</p>
<pre><code>&gt; dim( Xtr[[1]] )
[1] 64 64 64  1</code></pre>
<p>which is the size of the batch (64) and then spatial dimension of the input image (64x64) with just one channel.</p>
<p>point coordinate tensors are indexed in the following way:</p>
<ul>
<li>first index: subject (or batch) index</li>
<li>second index: which landmark we are going to index (eg the first, second etc)</li>
<li>third index : the point / landmark coordinate itself which will be a 2 vector in 2D and 3 vector in 3D</li>
</ul>
<p>e.g.</p>
<pre><code>&gt; dim( Xtr[[2]] )
[1] 64  4  2</code></pre>
<p>which is the size of the batch (64) and then number of landmarks (4 here) with 2 spatial dimensions.</p>
</div>
<div id="set-up-the-training-history-data-frame" class="section level2">
<h2 class="hasAnchor">
<a href="#set-up-the-training-history-data-frame" class="anchor"></a>set up the training history data frame</h2>
<p><strong>Run on GPU thread when setting up</strong></p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mydf</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">epoch</span> <span class="op">=</span> <span class="fl">1</span>
<span class="va">wtfn</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">'lm_weights_gpu'</span>, <span class="va">gpuid</span>,<span class="st">'.h5'</span><span class="op">)</span>
<span class="va">csvfn</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">'lm_weights_gpu'</span>, <span class="va">gpuid</span>,<span class="st">'.csv'</span><span class="op">)</span></code></pre></div>
</div>
<div id="using-the-data-in-a-training-loop-for-a-neural-network" class="section level2">
<h2 class="hasAnchor">
<a href="#using-the-data-in-a-training-loop-for-a-neural-network" class="anchor"></a>Using the data in a training loop for a neural network</h2>
<p>below is a “standard” tensorflow training loop with some alterations that make some efficiencies / choices a little more explicit but still clear. at least, that is what’s intended.</p>
<p><strong>Run on GPU thread when setting up</strong></p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">epoch</span> <span class="op">=</span> <span class="fl">1</span>
<span class="kw">for</span> <span class="op">(</span> <span class="va">ptwt</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span> <span class="fl">0.001</span>, <span class="fl">0.005</span>, <span class="fl">0.01</span>, <span class="fl">0.05</span>, <span class="fl">0.1</span> <span class="op">)</span> <span class="op">)</span> <span class="op">{</span>
  <span class="kw">if</span> <span class="op">(</span> <span class="va">ptwt</span> <span class="op">==</span> <span class="fl">0.01</span> <span class="op">)</span> <span class="va">unetLM</span> <span class="op">=</span> <span class="va">unetLM1</span>
  <span class="va">ptWeight</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="fu">cast</span><span class="op">(</span> <span class="va">ptwt</span>, <span class="va">mytype</span> <span class="op">)</span>
  <span class="va">num_epochs</span> <span class="op">&lt;-</span> <span class="fl">100</span>
  <span class="kw">if</span> <span class="op">(</span> <span class="va">ptwt</span> <span class="op">==</span> <span class="fl">0.1</span> <span class="op">)</span> <span class="va">num_epochs</span> <span class="op">=</span> <span class="fl">1500</span>
  <span class="va">optimizerE</span> <span class="op">&lt;-</span> <span class="va">tf</span><span class="op">$</span><span class="va">keras</span><span class="op">$</span><span class="va">optimizers</span><span class="op">$</span><span class="fu">Adam</span><span class="op">(</span><span class="fl">1.e-6</span><span class="op">)</span>
  <span class="va">batchsize</span> <span class="op">=</span> <span class="fl">2</span>
  <span class="kw">for</span> <span class="op">(</span><span class="va">epoch</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">num_epochs</span> <span class="op">)</span> <span class="op">{</span>
    <span class="kw">if</span> <span class="op">(</span> <span class="op">(</span><span class="va">epoch</span> <span class="op">%%</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">mybs</span><span class="op">/</span><span class="va">batchsize</span><span class="op">)</span> <span class="op">)</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">epoch</span> <span class="op">&gt;</span> <span class="fl">1</span>  <span class="op">)</span> <span class="op">{</span>
        <span class="co"># refresh the data</span>
        <span class="va">locfns</span> <span class="op">=</span> <span class="fu"><a href="../reference/chooseTrainingFilesToRead.html">chooseTrainingFilesToRead</a></span><span class="op">(</span> <span class="va">trtefns</span><span class="op">[</span>,<span class="va">trnnames</span><span class="op">]</span> <span class="op">)</span>
        <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span> <span class="va">locfns</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">)</span>
        <span class="va">Xtr</span> <span class="op">=</span> <span class="fu">surgeRy</span><span class="fu">::</span><span class="fu"><a href="../reference/loadNPData.html">loadNPData</a></span><span class="op">(</span> <span class="va">locfns</span> <span class="op">)</span>
      <span class="op">}</span>
    <span class="va">ct</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span> <span class="va">mydf</span> <span class="op">)</span> <span class="op">+</span> <span class="fl">1</span>
    <span class="va">mysam</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">Xtr</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, <span class="va">batchsize</span> <span class="op">)</span>
    <span class="va">datalist</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>
    <span class="va">datalist</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span><span class="op">(</span> <span class="va">Xtr</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="va">mysam</span>,,<span class="op">]</span>, dim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">Xtr</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="va">mysam</span>,,<span class="op">]</span><span class="op">)</span> <span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">tf</span><span class="op">$</span><span class="fu">cast</span><span class="op">(</span> <span class="va">mytype</span> <span class="op">)</span>
    <span class="kw">for</span> <span class="op">(</span> <span class="va">jj</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span> <span class="op">)</span>
      <span class="va">datalist</span><span class="op">[[</span><span class="va">jj</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span><span class="op">(</span> <span class="va">Xtr</span><span class="op">[[</span><span class="va">jj</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="va">mysam</span>,,,<span class="op">]</span>,
        dim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">batchsize</span>,<span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">Xtr</span><span class="op">[[</span><span class="va">jj</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">tf</span><span class="op">$</span><span class="fu">cast</span><span class="op">(</span> <span class="va">mytype</span> <span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">tf</span><span class="op">$</span><span class="fu">GradientTape</span><span class="op">(</span>persistent <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%as%</span> <span class="va">tape</span>, <span class="op">{</span>
      <span class="va">preds</span> <span class="op">=</span> <span class="fu">unetLM</span><span class="op">(</span> <span class="va">datalist</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span><span class="op">]</span> <span class="op">)</span>
      <span class="va">lossht</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">keras</span><span class="op">$</span><span class="va">losses</span><span class="op">$</span><span class="fu">mse</span><span class="op">(</span> <span class="va">datalist</span><span class="op">[[</span><span class="fl">5</span><span class="op">]</span><span class="op">]</span>, <span class="va">preds</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">tf</span><span class="op">$</span><span class="fu">reduce_mean</span><span class="op">(</span> <span class="op">)</span>
      <span class="va">losspt</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">keras</span><span class="op">$</span><span class="va">losses</span><span class="op">$</span><span class="fu">mse</span><span class="op">(</span> <span class="va">datalist</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, <span class="va">preds</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">tf</span><span class="op">$</span><span class="fu">reduce_mean</span><span class="op">(</span> <span class="op">)</span>
      <span class="va">loss</span> <span class="op">=</span> <span class="va">losspt</span> <span class="op">*</span> <span class="va">ptWeight</span> <span class="op">+</span> <span class="va">lossht</span>
      <span class="op">}</span><span class="op">)</span>
    <span class="va">unet_gradients</span> <span class="op">&lt;-</span> <span class="va">tape</span><span class="op">$</span><span class="fu">gradient</span><span class="op">(</span><span class="va">loss</span>, <span class="va">unetLM</span><span class="op">$</span><span class="va">trainable_variables</span><span class="op">)</span>
    <span class="va">optimizerE</span><span class="op">$</span><span class="fu">apply_gradients</span><span class="op">(</span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/transpose.html">transpose</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
        <span class="va">unet_gradients</span>, <span class="va">unetLM</span><span class="op">$</span><span class="va">trainable_variables</span> <span class="op">)</span><span class="op">)</span><span class="op">)</span>
    <span class="va">mydf</span><span class="op">[</span><span class="va">ct</span>,<span class="st">'train_loss'</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span> <span class="va">loss</span> <span class="op">)</span>
    <span class="va">mydf</span><span class="op">[</span><span class="va">ct</span>,<span class="st">'train_ptloss'</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span> <span class="va">losspt</span> <span class="op">)</span>
    <span class="va">mydf</span><span class="op">[</span><span class="va">ct</span>,<span class="st">'train_htloss'</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span> <span class="va">lossht</span> <span class="op">)</span>
    <span class="va">mydf</span><span class="op">[</span><span class="va">ct</span>,<span class="st">'ptWeight'</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span> <span class="va">ptWeight</span> <span class="op">)</span>
    <span class="kw">if</span><span class="op">(</span> <span class="va">epoch</span> <span class="op">&gt;</span> <span class="fl">3</span> <span class="op">&amp;</span> <span class="va">epoch</span> <span class="op">%%</span> <span class="fl">10</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">)</span> <span class="op">{</span>
      <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">tf</span><span class="op">$</span><span class="fu">device</span><span class="op">(</span><span class="st">"/cpu:0"</span><span class="op">)</span>, <span class="op">{</span>
        <span class="va">preds</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span> <span class="va">unetLM</span>, <span class="va">Xte</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span><span class="op">]</span> <span class="op">)</span>
        <span class="va">lossht</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">keras</span><span class="op">$</span><span class="va">losses</span><span class="op">$</span><span class="fu">mse</span><span class="op">(</span> <span class="va">Xte</span><span class="op">[[</span><span class="fl">5</span><span class="op">]</span><span class="op">]</span>, <span class="va">preds</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">tf</span><span class="op">$</span><span class="fu">reduce_mean</span><span class="op">(</span> <span class="op">)</span>
        <span class="va">losspt</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">keras</span><span class="op">$</span><span class="va">losses</span><span class="op">$</span><span class="fu">mse</span><span class="op">(</span> <span class="va">Xte</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, <span class="va">preds</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">tf</span><span class="op">$</span><span class="fu">reduce_mean</span><span class="op">(</span> <span class="op">)</span>
        <span class="va">loss</span> <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="fu">cast</span><span class="op">(</span><span class="va">losspt</span>, <span class="va">mytype</span><span class="op">)</span> <span class="op">*</span> <span class="va">ptWeight</span> <span class="op">+</span> <span class="va">tf</span><span class="op">$</span><span class="fu">cast</span><span class="op">(</span><span class="va">lossht</span>, <span class="va">mytype</span><span class="op">)</span>
      <span class="op">}</span><span class="op">)</span>
      <span class="co"># compute the same thing in test data</span>
      <span class="va">mydf</span><span class="op">[</span><span class="va">ct</span>,<span class="st">'test_loss'</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span> <span class="va">loss</span> <span class="op">)</span>
      <span class="va">mydf</span><span class="op">[</span><span class="va">ct</span>,<span class="st">'test_ptloss'</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span> <span class="va">losspt</span> <span class="op">)</span>
      <span class="va">mydf</span><span class="op">[</span><span class="va">ct</span>,<span class="st">'test_htloss'</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span> <span class="va">lossht</span> <span class="op">)</span>
      <span class="kw">if</span> <span class="op">(</span> <span class="va">mydf</span><span class="op">[</span><span class="va">ct</span>,<span class="st">'test_ptloss'</span><span class="op">]</span> <span class="op">&lt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">mydf</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">epoch</span>,<span class="st">'test_ptloss'</span><span class="op">]</span>,na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op">)</span> <span class="op">{</span>
        <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Saving"</span>,<span class="va">epoch</span><span class="op">)</span><span class="op">)</span>
        <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://keras.rstudio.com/reference/save_model_weights_hdf5.html">save_model_weights_hdf5</a></span><span class="op">(</span> <span class="va">unetLM</span>, <span class="va">wtfn</span> <span class="op">)</span>
        <span class="fu"><a href="https://rdrr.io/r/base/gc.html">gc</a></span><span class="op">(</span><span class="op">)</span>
      <span class="op">}</span>
    <span class="op">}</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span> <span class="va">mydf</span><span class="op">[</span><span class="va">ct</span>,<span class="op">]</span> <span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span> <span class="va">mydf</span>, <span class="va">csvfn</span>, row.names<span class="op">=</span><span class="cn">FALSE</span> <span class="op">)</span>
  <span class="op">}</span>
<span class="op">}</span></code></pre></div>
</div>
<div id="monitoring-training-progess" class="section level2">
<h2 class="hasAnchor">
<a href="#monitoring-training-progess" class="anchor"></a>monitoring training progess</h2>
<p>take a look at the training-test convergence curves.</p>
<p><strong>Run on CPU thread</strong></p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span> <span class="op">(</span> <span class="op">!</span> <span class="fu"><a href="https://rdrr.io/r/base/exists.html">exists</a></span><span class="op">(</span> <span class="st">"mydf"</span> <span class="op">)</span> <span class="op">)</span> <span class="va">mydf</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span> <span class="st">'lm_weights_gpu.csv'</span> <span class="op">)</span>
<span class="va">mydfnona</span> <span class="op">=</span> <span class="va">mydf</span><span class="op">[</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span> <span class="va">mydf</span><span class="op">$</span><span class="va">test_loss</span><span class="op">)</span>,  <span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/stats/ts.html">ts</a></span><span class="op">(</span> <span class="va">mydfnona</span> <span class="op">)</span> <span class="op">)</span></code></pre></div>
</div>
<div id="show-the-predicted-points-in-the-test-data" class="section level2">
<h2 class="hasAnchor">
<a href="#show-the-predicted-points-in-the-test-data" class="anchor"></a>show the predicted points in the test data</h2>
<p>Visualize the predicted points.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/layout.html">layout</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>,nrow<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="va">wsub</span> <span class="op">=</span> <span class="fl">1</span>
<span class="va">testimg</span> <span class="op">=</span> <span class="fu">as.antsImage</span><span class="op">(</span> <span class="va">Xte</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="va">wsub</span>,,,<span class="fl">1</span><span class="op">]</span> <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">antsCopyImageInfo2</span><span class="op">(</span> <span class="fu">rids</span><span class="op">(</span> <span class="fl">1</span> <span class="op">)</span> <span class="op">)</span>
<span class="va">preds</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span> <span class="va">unetLM</span>, <span class="va">Xte</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span><span class="op">]</span> <span class="op">)</span>
<span class="co"># these are in physical space</span>
<span class="va">predPoints</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html">as.array</a></span><span class="op">(</span> <span class="va">preds</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op">)</span><span class="op">[</span><span class="va">wsub</span>,,<span class="op">]</span>
<span class="va">truPoints</span> <span class="op">=</span> <span class="va">Xte</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="va">wsub</span>,,<span class="op">]</span> <span class="co"># true points</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Error"</span>,<span class="fu"><a href="https://rdrr.io/r/base/norm.html">norm</a></span><span class="op">(</span><span class="va">truPoints</span><span class="op">-</span><span class="va">predPoints</span>,<span class="st">"F"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"%Error"</span>,<span class="fu"><a href="https://rdrr.io/r/base/norm.html">norm</a></span><span class="op">(</span><span class="va">truPoints</span><span class="op">-</span><span class="va">predPoints</span>,<span class="st">"F"</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/norm.html">norm</a></span><span class="op">(</span><span class="va">truPoints</span>,<span class="st">"F"</span><span class="op">)</span><span class="op">*</span><span class="fl">100</span>,<span class="st">"%"</span><span class="op">)</span><span class="op">)</span>
<span class="va">truIndex</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span> <span class="fu">antsTransformPhysicalPointToIndex</span><span class="op">(</span> <span class="va">testimg</span>, <span class="va">truPoints</span> <span class="op">)</span> <span class="op">)</span>
<span class="va">predIndex</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span> <span class="fu">antsTransformPhysicalPointToIndex</span><span class="op">(</span> <span class="va">testimg</span>, <span class="va">predPoints</span> <span class="op">)</span> <span class="op">)</span>
<span class="co"># make point images</span>
<span class="va">truPointsImage</span> <span class="op">=</span> <span class="va">predPointsImage</span> <span class="op">=</span> <span class="va">testimg</span> <span class="op">*</span> <span class="fl">0</span>
<span class="kw">for</span> <span class="op">(</span> <span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span> <span class="va">truPoints</span> <span class="op">)</span> <span class="op">)</span> <span class="op">{</span>
  <span class="va">truPointsImage</span><span class="op">[</span><span class="va">truIndex</span><span class="op">[</span><span class="va">j</span>,<span class="fl">1</span><span class="op">]</span>,<span class="va">truIndex</span><span class="op">[</span><span class="va">j</span>,<span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">=</span><span class="va">j</span>
  <span class="va">predPointsImage</span><span class="op">[</span><span class="va">predIndex</span><span class="op">[</span><span class="va">j</span>,<span class="fl">1</span><span class="op">]</span>,<span class="va">predIndex</span><span class="op">[</span><span class="va">j</span>,<span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">=</span><span class="va">j</span>
  <span class="op">}</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="va">testimg</span>, <span class="fu">iMath</span><span class="op">(</span> <span class="va">truPointsImage</span>, <span class="st">"GD"</span>,<span class="fl">2</span><span class="op">)</span> <span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="va">testimg</span>, <span class="fu">iMath</span><span class="op">(</span> <span class="va">predPointsImage</span>, <span class="st">"GD"</span>,<span class="fl">2</span><span class="op">)</span> <span class="op">)</span></code></pre></div>
</div>
<div id="look-at-some-of-the-underlying-images" class="section level2">
<h2 class="hasAnchor">
<a href="#look-at-some-of-the-underlying-images" class="anchor"></a>look at some of the underlying images</h2>
<p>Visualize the predicted images.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/layout.html">layout</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">8</span>,nrow<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="va">wsub</span> <span class="op">=</span> <span class="fl">6</span>
<span class="kw">for</span> <span class="op">(</span> <span class="va">wpt</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">segregions</span><span class="op">)</span> <span class="op">)</span> <span class="op">{</span>
  <span class="va">preds</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span> <span class="va">unetLM</span>, <span class="va">Xte</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span><span class="op">]</span> <span class="op">)</span>
  <span class="va">testimg</span> <span class="op">=</span> <span class="fu">as.antsImage</span><span class="op">(</span> <span class="va">Xte</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="va">wsub</span>,,,<span class="fl">1</span><span class="op">]</span> <span class="op">)</span>
  <span class="va">testmsk</span> <span class="op">=</span> <span class="fu">as.antsImage</span><span class="op">(</span> <span class="va">Xte</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="va">wsub</span>,,,<span class="fl">1</span><span class="op">]</span> <span class="op">)</span>
  <span class="va">testht</span> <span class="op">=</span> <span class="fu">as.antsImage</span><span class="op">(</span> <span class="va">Xte</span><span class="op">[[</span><span class="fl">5</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="va">wsub</span>,,,<span class="va">wpt</span><span class="op">]</span> <span class="op">)</span>
  <span class="va">testcc</span> <span class="op">=</span> <span class="fu">as.antsImage</span><span class="op">(</span> <span class="va">Xte</span><span class="op">[[</span><span class="fl">4</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="va">wsub</span>,,,<span class="fl">2</span><span class="op">]</span> <span class="op">)</span> <span class="co"># coord conv</span>
  <span class="va">testhtp</span> <span class="op">=</span> <span class="fu">as.antsImage</span><span class="op">(</span> <span class="va">preds</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="va">wsub</span>,,,<span class="va">wpt</span><span class="op">]</span> <span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="va">testimg</span>, <span class="va">testht</span> <span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="va">testimg</span>, <span class="va">testhtp</span> <span class="op">)</span>
  <span class="op">}</span></code></pre></div>
</div>
<div id="inference-in-completely-out-of-sample-data" class="section level2">
<h2 class="hasAnchor">
<a href="#inference-in-completely-out-of-sample-data" class="anchor"></a>Inference in completely out of sample data</h2>
<p>Inference follows the same patterns as above but there are many ways that one can implement it. Please implement inference on your own.</p>
<p><strong>Run on CPU thread when done</strong></p>
</div>
<div id="future-work" class="section level2">
<h2 class="hasAnchor">
<a href="#future-work" class="anchor"></a>Future work</h2>
<p>The package will evolve with the associated needs of related projects. NOTE: this example is really very trivial and is not meant to “work” on a real problem. However, it has been tested in very close form on real non-trivial problems with very similar parameters.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Brian B Avants, Nicholas J Tustison.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
